<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Dashboard - Medicine Reminder</title>
  <link rel="stylesheet" href="styles.css">
  <style>

* {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f9;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 25px;
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .topbar h2 {
      font-size: 1.5rem;
      color: #007bff;
    }

    .topbar .actions button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
    }

    .topbar .actions button:hover {
      opacity: 0.85;
    }

    .topbar button.logout {
      background: #dc3545;
      color: #fff;
    }

    .topbar button.stopAll {
      background: #ffc107;
      color: #333;
    }

    .topbar button.profile {
      background: #007bff;
      color: #fff;
    }

    h3 {
      margin: 20px 0 10px;
      color: #007bff;
      font-size: 1.3rem;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      background: #fff;
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }

    form input,
    form select,
    form button {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      transition: 0.2s;
    }

    form input:focus,
    form select:focus {
      border-color: #007bff;
      outline: none;
    }

    form button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    form button:hover {
      opacity: 0.9;
    }

    .msg {
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
      display: none;
      font-weight: 500;
    }

    .msg.success {
      background: #d4edda;
      color: #155724;
    }

    .msg.error {
      background: #f8d7da;
      color: #721c24;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      margin: 8px 0;
      padding: 12px 16px;
      border-radius: 10px;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: 0.2s;
    }

    li:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    li button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #dc3545;
      color: #fff;
      transition: 0.2s;
    }

    li button:hover {
      opacity: 0.85;
    }

    .calendar {
      display: grid;
      grid-template-columns: 120px repeat(7, 1fr);
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .calendar .header {
      background: #007bff;
      color: white;
      text-align: center;
      padding: 10px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .calendar .time {
      background: #f1f1f1;
      text-align: right;
      padding: 8px;
      font-weight: 500;
      border-bottom: 1px solid #ddd;
      font-size: 0.85rem;
    }

    .calendar .cell {
      border-bottom: 1px solid #ddd;
      border-right: 1px solid #ddd;
      min-height: 60px;
      padding: 6px;
      font-size: 12px;
      overflow-y: auto;
      transition: 0.2s;
    }

    .calendar .cell:last-child {
      border-right: none;
    }

    .calendar .cell.today {
      background: #fff8e1;
    }

    .calendar .event {
      display: block;
      background: #28a745;
      color: white;
      border-radius: 6px;
      padding: 3px 6px;
      margin: 3px 0;
      font-size: 11px;
      cursor: pointer;
      transition: 0.2s;
    }

    .calendar .event:hover {
      background: #218838;
    }

    .popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #007bff;
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 9999;
      animation: slideIn 0.5s ease;
    }

    .popup button {
      background: white;
      color: #007bff;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      width: 360px;
      max-width: 90%;
      text-align: left;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
    }

    .modal-content h4 {
      margin-top: 0;
      color: #007bff;
    }

    .modal-content input,
    .modal-content select {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .modal-content .btns {
      text-align: right;
      margin-top: 12px;
    }

    .modal-content button {
      margin-left: 8px;
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .modal-content button:hover {
      opacity: 0.9;
    }

    #previewModal .modal-content {
      width: 80%;
      height: 80%;
      max-width: 900px;
      max-height: 700px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #previewModal iframe,
    #previewModal img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      margin-bottom: 12px;
    }

    #previewModal a button {
      margin-top: 8px;
      background: #28a745;
      color: white;
    }

    @media(max-width:768px) {
      .calendar {
        grid-template-columns: 60px repeat(7, 1fr);
      }

      form {
        flex-direction: column;
      }

      .topbar {
        flex-direction: column;
        gap: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h2><span id="welcomeText"></span>, <span id="username"></span></h2>
      <div class="actions">
        <button onclick="goProfile()" id="profileBtn"></button>
        <button class="stopAll" onclick="stopAllAlarms()" id="stopAllBtn"></button>
        <button class="logout" onclick="logout()" id="logoutBtn"></button>
      </div>
    </div>

    <!-- Medicines -->
    <h3 id="medicinesHeading"></h3>
    <form id="medicineForm">
      <input type="text" id="medName" placeholder="" required>
      <input type="text" id="medDosage" placeholder="">
      <label id="timeLabel"></label>
      <input type="time" id="medTime" required>
      <label id="daysLabel"></label>
      <select id="medDays" multiple required>
        <option value="sun">Sun</option>
        <option value="mon">Mon</option>
        <option value="tue">Tue</option>
        <option value="wed">Wed</option>
        <option value="thu">Thu</option>
        <option value="fri">Fri</option>
        <option value="sat">Sat</option>
      </select>
      <button type="submit" id="addMedBtn"></button>
    </form>
    <div id="medMsg" class="msg"></div>
    <ul id="medicineList"></ul>

    <!-- Calendar -->
    <h3 id="calendarHeading"></h3>
    <div id="calendar" class="calendar"></div>

    <!-- Prescriptions -->
    <h3 id="prescriptionsHeading"></h3>
    <form id="prescriptionForm" enctype="multipart/form-data">
      <input type="text" id="doctorName" placeholder="" required>
      <input type="file" id="presFile" accept=".pdf,.jpg,.jpeg,.png" required>
      <button type="submit" id="addPrescriptionBtn"></button>
    </form>
    <div id="presMsg" class="msg"></div>
    <ul id="prescriptionList"></ul>

    <!-- Doctors -->
    <h3 id="doctorsHeading"></h3>
    <form id="doctorForm">
      <input type="text" id="docName" placeholder="" required>
      <input type="text" id="docSpecialty" placeholder="Specialty">
      <input type="text" id="docPhone" placeholder="Phone">
      <input type="email" id="docEmail" placeholder="Email">
      <button type="submit" id="addDoctorBtn"></button>
    </form>
    <div id="docMsg" class="msg"></div>
    <ul id="doctorList"></ul>
  </div>

  <!-- Modals -->
  <div id="eventModal" class="modal" onclick="if(event.target===this) closeModal();">
    <div class="modal-content">
      <h4>Edit Medicine</h4>
      <input type="text" id="editName">
      <input type="text" id="editDosage">
      <input type="time" id="editTime">
      <label>Days:</label>
      <select id="editDays" multiple>
        <option value="sun">Sun</option>
        <option value="mon">Mon</option>
        <option value="tue">Tue</option>
        <option value="wed">Wed</option>
        <option value="thu">Thu</option>
        <option value="fri">Fri</option>
        <option value="sat">Sat</option>
      </select>
      <div class="btns">
        <button id="modalSave">Save</button>
        <button id="modalDelete">Delete</button>
        <button onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <div id="previewModal" class="modal" onclick="if(event.target===this) closePreview();">
    <div class="modal-content">
      <div id="previewContent"
        style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"></div>
      <div class="btns"><button onclick="closePreview()">Close</button></div>
    </div>
  </div>

  <script>
    // Initialization 
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));
    if (!token) window.location.href = "login.html";
    document.getElementById("username").innerText = user?.name || "";
    const currentLang = user?.language || "en";

    // Translations
    const translations = {
      en: {
        welcome: "Welcome", profile: "Profile", logout: "Logout", stop_all: "Stop All",
        your_medicines: "Your Medicines", medicine_name: "Medicine Name", dosage: "Dosage",
        time: "Time", days: "Days", add_medicine: "Add Medicine", reminder_body: "{name} - {dosage}",
        prescriptions: "Prescriptions", add_prescription: "Upload Prescription",
        doctors: "Doctors", doctor_name: "Doctor Name", doctor_phone: "Phone", doctor_email: "Email",
        add_doctor: "Add Doctor", calendar: "Medicine Calendar"
      },
      hi: {
        welcome: "‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à", profile: "‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤", logout: "‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü", stop_all: "‡§∏‡§≠‡•Ä ‡§∞‡•ã‡§ï‡•á‡§Ç",
        your_medicines: "‡§Ü‡§™‡§ï‡•Ä ‡§¶‡§µ‡§æ‡§á‡§Ø‡§æ‡§Å", medicine_name: "‡§¶‡§µ‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ", dosage: "‡§ñ‡•Å‡§∞‡§æ‡§ï", time: "‡§∏‡§Æ‡§Ø", days: "‡§¶‡§ø‡§®",
        add_medicine: "‡§¶‡§µ‡§æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç", reminder_body: "{name} - {dosage}", prescriptions: "‡§™‡•ç‡§∞‡§ø‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§®",
        add_prescription: "‡§™‡•ç‡§∞‡§ø‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç", doctors: "‡§°‡•â‡§ï‡•ç‡§ü‡§∞", doctor_name: "‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ",
        doctor_phone: "‡§´‡§º‡•ã‡§®", doctor_email: "‡§à‡§Æ‡•á‡§≤", add_doctor: "‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç", calendar: "‡§¶‡§µ‡§æ ‡§ï‡•à‡§≤‡•á‡§Ç‡§°‡§∞"
      },
      gu: {
        welcome: "‡™∏‡´ç‡™µ‡™æ‡™ó‡™§ ‡™õ‡´á", profile: "‡™™‡´ç‡™∞‡´ã‡™´‡™æ‡™á‡™≤", logout: "‡™≤‡´ã‡™ó ‡™Ü‡™â‡™ü", stop_all: "‡™¨‡™ß‡™æ ‡™∞‡´ã‡™ï‡´ã",
        your_medicines: "‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™¶‡™µ‡™æ‡™ì", medicine_name: "‡™¶‡™µ‡™æ ‡™®‡™æ‡™Æ", dosage: "‡™°‡´ã‡™ù", time: "‡™∏‡™Æ‡™Ø", days: "‡™¶‡™ø‡™µ‡™∏‡´ã",
        add_medicine: "‡™¶‡™µ‡™æ ‡™â‡™Æ‡´á‡™∞‡´ã", reminder_body: "{name} - {dosage}", prescriptions: "‡™™‡´ç‡™∞‡™ø‡™∏‡´ç‡™ï‡´ç‡™∞‡™ø‡™™‡´ç‡™∂‡™®",
        add_prescription: "‡™™‡´ç‡™∞‡™ø‡™∏‡´ç‡™ï‡´ç‡™∞‡™ø‡™™‡´ç‡™∂‡™® ‡™Ö‡™™‡™≤‡´ã‡™° ‡™ï‡™∞‡´ã", doctors: "‡™°‡´ã‡™ï‡´ç‡™ü‡™∞‡´ç‡™∏", doctor_name: "‡™°‡´ã‡™ï‡´ç‡™ü‡™∞ ‡™®‡™æ‡™Æ",
        doctor_phone: "‡™´‡´ã‡™®", doctor_email: "‡™à‡™Æ‡´á‡™à‡™≤", add_doctor: "‡™°‡´ã‡™ï‡´ç‡™ü‡™∞ ‡™â‡™Æ‡´á‡™∞‡´ã", calendar: "‡™¶‡™µ‡™æ ‡™ï‡´Ö‡™≤‡´á‡™®‡´ç‡™°‡™∞"
      },
      es: {
        welcome: "Bienvenido", profile: "Perfil", logout: "Cerrar sesi√≥n", stop_all: "Detener todo",
        your_medicines: "Tus Medicinas", medicine_name: "Nombre de Medicina", dosage: "Dosis", time: "Hora", days: "D√≠as",
        add_medicine: "Agregar Medicina", reminder_body: "{name} - {dosage}", prescriptions: "Recetas",
        add_prescription: "Subir Receta", doctors: "Doctores", doctor_name: "Nombre del Doctor",
        doctor_phone: "Tel√©fono", doctor_email: "Correo", add_doctor: "Agregar Doctor", calendar: "Calendario de Medicinas"
      },
      fr: {
        welcome: "Bienvenue", profile: "Profil", logout: "D√©connexion", stop_all: "Tout arr√™ter",
        your_medicines: "Vos M√©dicaments", medicine_name: "Nom du M√©dicament", dosage: "Dosage", time: "Heure", days: "Jours",
        add_medicine: "Ajouter M√©dicament", reminder_body: "{name} - {dosage}", prescriptions: "Ordonnances",
        add_prescription: "T√©l√©verser Ordonnance", doctors: "M√©decins", doctor_name: "Nom du M√©decin",
        doctor_phone: "T√©l√©phone", doctor_email: "Email", add_doctor: "Ajouter M√©decin", calendar: "Calendrier M√©dicaments"
      }
    };

    function applyTranslations() {
      const t = translations[currentLang] || translations.en;
      document.getElementById("welcomeText").innerText = t.welcome;
      document.getElementById("profileBtn").innerText = t.profile;
      document.getElementById("logoutBtn").innerText = t.logout;
      document.getElementById("stopAllBtn").innerText = t.stop_all;
      document.getElementById("medicinesHeading").innerText = t.your_medicines;
      document.getElementById("medName").placeholder = t.medicine_name;
      document.getElementById("medDosage").placeholder = t.dosage;
      document.getElementById("timeLabel").innerText = t.time + ":";
      document.getElementById("daysLabel").innerText = t.days + ":";
      document.getElementById("addMedBtn").innerText = t.add_medicine;
      document.getElementById("prescriptionsHeading").innerText = t.prescriptions;
      document.getElementById("addPrescriptionBtn").innerText = t.add_prescription;
      document.getElementById("doctorsHeading").innerText = t.doctors;
      document.getElementById("docName").placeholder = t.doctor_name;
      document.getElementById("docPhone").placeholder = t.doctor_phone;
      document.getElementById("docEmail").placeholder = t.doctor_email;
      document.getElementById("addDoctorBtn").innerText = t.add_doctor;
      document.getElementById("calendarHeading").innerText = t.calendar;
    }
    applyTranslations();

    // Utilities
    function showMsg(id, text, success = true) { const box = document.getElementById(id); box.innerText = text; box.className = "msg " + (success ? "success" : "error"); box.style.display = "block"; setTimeout(() => box.style.display = "none", 3000); }

    // Medicines
    let currentMedicines = [], editingMed = null;
    const days = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];

    function buildCalendar(meds) {
      const cal = document.getElementById("calendar"); cal.innerHTML = "";
      cal.appendChild(document.createElement("div")); // empty top-left
      days.forEach((d, i) => { const div = document.createElement("div"); div.className = "header"; div.innerText = d.toUpperCase(); cal.appendChild(div); });
      ["Morning", "Afternoon", "Evening", "Night"].forEach((slot, slotIdx) => {
        const tDiv = document.createElement("div"); tDiv.className = "time"; tDiv.innerText = slot; cal.appendChild(tDiv);
        days.forEach((day) => {
          const cell = document.createElement("div"); cell.className = "cell";
          meds.forEach(m => {
            (m.schedules || []).forEach(s => {
              if (!s.days.includes(day)) return;
              const h = +s.time.split(":")[0]; const si = (h >= 6 && h <= 11) ? 0 : (h >= 12 && h <= 17) ? 1 : (h >= 18 && h <= 21) ? 2 : 3;
              if (si === slotIdx) { const ev = document.createElement("span"); ev.className = "event"; ev.innerText = `${m.name} (${m.dosage}) @ ${s.time}`; ev.onclick = () => openModal(m, s); cell.appendChild(ev); }
            });
          });
          cal.appendChild(cell);
        });
      });
    }

    async function loadMedicines() {
      const res = await fetch("/api/medicines", { headers: { "Authorization": "Bearer " + token } });
      const data = await res.json();
      currentMedicines = data.medicines || [];
      const list = document.getElementById("medicineList"); list.innerHTML = "";
      currentMedicines.forEach(m => {
        const times = (m.schedules || []).map(s => `${s.time} (${s.days.join(',')})`).join(' | ');
        const li = document.createElement("li");
        li.innerHTML = `<span>${m.name} - ${m.dosage} <br><small>Schedule: ${times}</small></span>
                  <button onclick="deleteMedicine(${m.id})">Delete</button>`;
        list.appendChild(li);
      });
      buildCalendar(currentMedicines);
    }

    async function deleteMedicine(id) { await fetch(`/api/medicines/${id}`, { method: "DELETE", headers: { "Authorization": "Bearer " + token } }); loadMedicines(); }

    document.getElementById("medicineForm").onsubmit = async e => {
      e.preventDefault();
      const body = { name: medName.value.trim(), dosage: medDosage.value.trim(), schedules: [{ time: medTime.value, days: Array.from(medDays.selectedOptions).map(o => o.value) }] };
      await fetch("/api/medicines", { method: "POST", headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }, body: JSON.stringify(body) });
      showMsg("medMsg", "Medicine saved!"); e.target.reset(); loadMedicines();
    }

    // Edit Modal
    function openModal(med, sch) {
      editingMed = med; editName.value = med.name; editDosage.value = med.dosage; editTime.value = sch.time;
      Array.from(editDays.options).forEach(o => o.selected = sch.days.includes(o.value));
      eventModal.style.display = "flex";
      modalSave.onclick = async () => { const body = { name: editName.value, dosage: editDosage.value, schedules: [{ time: editTime.value, days: Array.from(editDays.selectedOptions).map(o => o.value) }] }; await fetch(`/api/medicines/${med.id}`, { method: "PUT", headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }, body: JSON.stringify(body) }); closeModal(); loadMedicines(); };
      modalDelete.onclick = async () => { await deleteMedicine(med.id); closeModal(); };
    }
    function closeModal() { eventModal.style.display = "none"; }

    // Prescriptions
    async function loadPrescriptions() {
      const res = await fetch("/api/prescriptions", { headers: { "Authorization": "Bearer " + token } });
      const data = await res.json();
      const list = prescriptionList;
      list.innerHTML = "";
      (data.prescriptions || []).forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${p.doctor_name || ""} - ${p.original_name}</span>
      <div>
        <button onclick="previewPrescription('${p.filename}','${p.original_name}')">Preview</button>
        <a href="/uploads/${p.filename}" download="${p.original_name}">
          <button>Download</button>
        </a>
        <button onclick="deletePrescription(${p.id})">Delete</button>
      </div>`;
        list.appendChild(li);
      });
    }

    prescriptionForm.onsubmit = async e => {
      e.preventDefault();
      const fd = new FormData(); fd.append("doctor_name", doctorName.value.trim()); fd.append("file", presFile.files[0]);
      await fetch("/api/upload_prescription", { method: "POST", headers: { "Authorization": "Bearer " + token }, body: fd });
      showMsg("presMsg", "Uploaded!"); e.target.reset(); loadPrescriptions();
    };

    // Preview Modal stays the same
    function previewPrescription(file, name) {
      const ext = name.split(".").pop().toLowerCase();
      const content = previewContent;
      content.innerHTML = "";
      if (["jpg", "jpeg", "png"].includes(ext)) {
        const img = document.createElement("img");
        img.src = "/uploads/" + file;
        content.appendChild(img);
      } else if (ext === "pdf") {
        const iframe = document.createElement("iframe");
        iframe.src = "/uploads/" + file;
        content.appendChild(iframe);
      } else {
        content.innerText = "Preview not available";
      }
      // Add Download button inside preview modal
      const downloadBtn = document.createElement("a");
      downloadBtn.href = "/uploads/" + file;
      downloadBtn.download = name;
      downloadBtn.innerHTML = `<button>Download</button>`;
      content.appendChild(downloadBtn);

      previewModal.style.display = "flex";
    }

    function closePreview() { previewModal.style.display = "none"; }
    async function deletePrescription(id) { await fetch(`/api/prescriptions/${id}`, { method: "DELETE", headers: { "Authorization": "Bearer " + token } }); loadPrescriptions(); }

    // Doctors
    async function loadDoctors() {
      const res = await fetch("/api/doctors", { headers: { "Authorization": "Bearer " + token } });
      const data = await res.json(); const list = doctorList; list.innerHTML = "";
      (data.doctors || []).forEach(d => {
        const li = document.createElement("li");
        li.innerHTML = `<span>${d.name} ${d.specialty ? `(${d.specialty})` : ''}</span>
                 <div>${d.phone ? `<a href="tel:${d.phone}">üìû</a>` : ''}${d.email ? `<a href="mailto:${d.email}">‚úâÔ∏è</a>` : ''}
                 <button onclick="deleteDoctor(${d.id})">Delete</button></div>`;
        list.appendChild(li);
      });
    }

    doctorForm.onsubmit = async e => {
      e.preventDefault();
      const body = { name: docName.value.trim(), specialty: docSpecialty.value.trim(), phone: docPhone.value.trim(), email: docEmail.value.trim() };
      await fetch("/api/doctors", { method: "POST", headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }, body: JSON.stringify(body) });
      showMsg("docMsg", "Doctor saved!"); e.target.reset(); loadDoctors();
    };

    async function deleteDoctor(id) { await fetch(`/api/doctors/${id}`, { method: "DELETE", headers: { "Authorization": "Bearer " + token } }); loadDoctors(); }

    // Notifications
    let firedReminders = {};
    function showPopup(message) {
      const popup = document.createElement("div"); popup.className = "popup"; const audio = new Audio("alarm.mp3"); audio.loop = true;
      popup.innerHTML = `<span>${message}</span><button>Stop</button>`; popup.querySelector("button").onclick = () => { audio.pause(); audio.currentTime = 0; popup.remove(); };
      document.body.appendChild(popup); audio.play();
      if (Notification.permission === "granted") { new Notification("Medicine Reminder", { body: message, icon: "/favicon.ico" }); }
      else if (Notification.permission !== "denied") { Notification.requestPermission().then(p => { if (p === "granted") { new Notification("Medicine Reminder", { body: message, icon: "/favicon.ico" }); } }); }
    }

    async function checkMedicinesRealtime() {
      const res = await fetch("/api/medicines", { headers: { "Authorization": "Bearer " + token } });
      const data = await res.json(); const now = new Date(); const today = days[now.getDay()]; const currentMinutes = now.getHours() * 60 + now.getMinutes();
      (data.medicines || []).forEach(m => {
        (m.schedules || []).forEach(sch => {
          if (!sch.days.includes(today)) return;
          const [h, m] = sch.time.split(":").map(Number); const scheduleMinutes = h * 60 + m; const medKey = m.id + "_" + sch.time;
          if (Math.abs(currentMinutes - scheduleMinutes) === 0 && !firedReminders[medKey]) {
            const msg = translations[currentLang].reminder_body.replace("{name}", m.name).replace("{dosage}", m.dosage);
            showPopup(msg); firedReminders[medKey] = true;
          }
        });
      });
    }

    function stopAllAlarms() {
      document.querySelectorAll(".popup").forEach(p => p.remove());
      document.querySelectorAll("audio").forEach(a => { a.pause(); a.currentTime = 0; });
    }

    setInterval(() => { firedReminders = {}; }, 24 * 60 * 60 * 1000);
    setInterval(checkMedicinesRealtime, 10000);

    if ("serviceWorker" in navigator) { navigator.serviceWorker.register("sw.js").then(() => console.log("SW registered")).catch(console.error); }
    function logout() { localStorage.clear(); window.location.href = "login.html"; }
    function goProfile() { window.location.href = "profile.html"; }

    loadMedicines(); loadPrescriptions(); loadDoctors();
  </script>
</body>

</html>